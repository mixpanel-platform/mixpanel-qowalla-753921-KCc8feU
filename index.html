<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://d621cde4587c562960fbe230744f42dc2304ca4f.googledrive.com/host/0BxwayM8qQaCVX0w4RExCOVdhbzQ">
     <link rel="stylesheet" type="text/css" href="https://5a4961e5c9f1459a1c463234568af125d8e1b386.googledrive.com/host/0BxwayM8qQaCVRmRCSDlXUUtMMnc/">
  <link rel="stylesheet" type="text/css" href="https://201420392a7158f07d53a8f3e71606645ab03bd2.googledrive.com/host/0BxwayM8qQaCVQldvY2U5Um9FN3M">
    <script src="https://cdn.datatables.net/1.10.9/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.9/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"   integrity="sha256-xNjb53/rY+WmG+4L6tTl9m6PpqknWZvRt0rO1SRnJzw=" crossorigin="anonymous"></script>

  </head>
  <body class="mixpanel-platform-body">
    <style>
      #dateRange .select_button {
        height: 30px;
      }
    </style>
    <div class="content-wrapper">
        <div class="content-heading text-center">
          <!-- START Language list-->
          <div class="pull-right" style="bottom: 10px;">
            <img src="https://d018d7277c9a2a72c253b637c4abe4d24d29449c.googledrive.com/host/0BxwayM8qQaCVOGZvekkxYTNSZVU" height="40px" width="120px">
            
          </div>
          <div class="pull-left">
          </div>
          <!-- END Language list    -->
          Qowalla's Dashboard
          <small data-localize="dashboard.WELCOME"></small>
        </div>
        <!-- START widgets box-->
        <div class="row">
          <div class="col-lg-3 col-sm-3">
            <!-- START widget-->
            <div class="panel widget bg-primary">
              <div class="row row-table">
                <div class="col-xs-4 text-center bg-primary-dark pv-lg">
                  <i class="fa fa-cloud-download fa-3x"></i>
                </div>
                <div class="col-xs-8 pv-lg">
                  <div class="h2 mt0 total-downloads text-center">0</div>
                  <div class="text-uppercase text-center">Total Downloads</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-sm-3">
            <!-- START widget-->
            <div class="panel widget bg-purple">
              <div class="row row-table">
                <div class="col-xs-4 text-center bg-purple-dark pv-lg">
                  <i class="fa fa-shopping-cart fa-3x"></i>
                </div>
                <div class="col-xs-8 pv-lg">
                  <div class="h2 mt0 average-cart text-center">0
                    <!--<small>GB</small>-->
                  </div>
                  <div class="text-uppercase text-center">Average Order Value</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 col-sm-3">
            <!-- START widget-->
            <div class="panel widget bg-green">
              <div class="row row-table">
                <div class="col-xs-4 text-center bg-green-dark pv-lg">
                  <i class="fa fa-money fa-3x"></i>
                </div>
                <div class="col-xs-8 pv-lg">
                  <div class="h2 mt0 daily-actives text-center">0</div>
                  <div class="text-uppercase text-center">Total Purchases</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 col-sm-3">
            <!-- START widget-->
            <div class="panel widget bg-primary">
              <div class="row row-table">
                <div class="col-xs-4 text-center bg-primary-dark pv-lg">
                  <i class="fa fa-percent fa-3x"></i>
                </div>
                <div class="col-xs-8 pv-lg">
                  <div class="h2 mt0 conversion text-center">0</div>
                  <div class="text-uppercase text-center">Conversion</div>
                </div>
              </div>
            </div>
          </div>
            <!-- START date widget-->
            <div class="panel widget">
              <div class="row row-table">
                <div class="col-xs-4 text-center bg-green pv-lg">
                  <!-- See formats: https://docs.angularjs.org/api/ng/filter/date-->
                  <div data-now="" data-format="MMMM" class="text-sm date-month text-center"></div>
                  <br>
                  <div data-now="" data-format="D" class="h2 mt0 date-day text-center"></div>
                </div>
                <div class="col-xs-8 pv-lg">
                  <div data-now="" data-format="dddd" class="text-uppercase date-actual-day text-center"></div>
                  <br>
                  <div data-now="" data-format="h:mm" class="h2 mt0 date-time"></div>
                  <div data-now="" data-format="a" class="text-muted text-sm date-pm"></div>
                </div>
              </div>
            </div>
            <!-- END date widget    -->
          </div>
        </div>
        <div class="row">
          <div class="col-lg-12">
            <div class="panel panel-default">
              <div class="panel-heading text-center">
                Metrics
              </div>
              <input type="text" id="dateSelect"><br/><br/>
              <div style="clear: both;"></div>
              <div id="dateRange"></div>
              <div class="panel-body">
                <div id="datatable1_wrapper" class="dataTables_wrapper form-inline no-footer">
                  <div class="row">
                    <table id="table" class="display" width="100%"></table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>


    <script>
        /* Get top events */
      function percent(numerator, denominator){
        var value = 0
        if (denominator != 0){
          value = Math.floor( numerator / denominator * 100)
        }
        return value
      }
      
        var dateSelect  = $('#dateSelect').datepicker({
          maxDate: new Date(),
        });
        
        $( "#dateSelect" ).datepicker( "setDate", new Date() )
        var options = {
            items: [
              {label: 'Day', value: 'day'},
              {label: 'Week', value: 'week'},
              {label: 'Month', value: 'month'},
            ]
        };
        
        var unit = $('#dateRange').MPSelect(options);
        var table = $('#table').DataTable( {
            columns: [
                { title: "Metric" , data: 'Metric' },
                { title: "Current", data: 'Current' },
                { title: "Previous", data: 'Previous' },
                { title: "Difference", data: 'Difference' },
              ]
        });

       
        events = [];
        MP.api.topEvents().done(function(results) {
          _.each(_.values(results.values()), function(value){
              events.push(value);
          })
          query()
        });

        function toTitleCase(str){
          return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
        }

        function addCommas(intNum) {
          return (intNum + '').replace(/(\d)(?=(\d{3})+$)/g, '$1,');
        }

        function query() {
          /* 
              Get total event counts 
              event:App Open
              type:general
              limit:255
              on:properties["First App Open"]
              to_date:2015-11-11
              from_date:2015-10-13
              unit:day
          */
          var params = {}
          var paramsLastPeriod = {}
          var period = null
          
          /* Query for total Downloads */
          var downloadsQuery = MP.api.segment('App Open', {where:'properties["First App Open"] == true', unit: 'month',type:'unique', from: moment().subtract(12, 'months')})
          
          downloadsQuery.done(function(json) {
              /* Show this now */
              var total = _.sum(_.values(json.values()['App Open']));
              $('.total-downloads').text(addCommas(total));
            })
            
            /* Query for Average Cart Value */
            var purchParams = {
              event: 'Purchase',
              type: 'general',
              limit: 10000,
              on: 'number(properties["Purchase Dollar Amount"])',
              unit: 'day',
              to: moment(),
              from: moment().subtract(12, 'months'),
            }
            
            var averageCart = MP.api.query('/api/2.0/segmentation/average', purchParams, {dataType: 'json'}) 
            averageCart.done(function(json){
                var data = _.values(json.results)
                var averageCartVals = (data.reduce(function(sum, a) { return sum + Number(a) }, 0) / data.length).toFixed(2)
                $('.average-cart').text(addCommas('$' + averageCartVals));
            });
            
            /* Year to Date Purchases */
            var purchaseQuery = MP.api.events('Purchase', {from: moment().subtract(12, 'months'), unit: 'month'})
            purchaseQuery.done(function(json){
                var total = _.sum(_.values(json.values()['Purchase']));
                $('.daily-actives').text(addCommas(total));
                
            })
            /* update datatable to meet the email from jennifer */
            var table = $('#datatable1').DataTable();
            table.clear();
            
          /* Total Conversion */
           var segParams = {
              type: 'general',
              limit: 10000,
              to: moment(),
              from: moment().subtract(12, 'months'),
            }
          var app = MP.api.segment('App Open', segParams)
          var purch = MP.api.segment('Purchase', segParams)
          $.when(app, purch).done(function(app, purch){
            debugger
            //redo this to truly account for % diff
            // total downloads over time frame / app opens.
            // Formulas cant work
            var currentData =  percent(MP.Data.inst(purch.json["Purchase"]).sum().values(), MP.Data.inst(app.json["App Open"]).sum().values());
            $('.conversion').text(String(currentData) + "%");
          })
        }
        

        function tableData(){
          table.clear()
          var date = moment(dateSelect.val())
          
          var dateObj = {
            to: date.utc().format('YYYY-MM-DD'),
            from: date.subtract(1, unit.val()).utc().format('YYYY-MM-DD')
          }
          
          var previousRange = {
            to: moment(dateObj.from).subtract(1, unit.val()).utc().format('YYYY-MM-DD'),
            from: moment(dateObj.from).subtract(2, unit.val()).utc().format('YYYY-MM-DD')
          }
          
          var purchParams = {
              event: 'Purchase',
              type: 'general',
              limit: 10000,
              on: 'number(properties["Purchase Dollar Amount"])',
              unit: unit.val(),
            }
            
          var currentAOV = MP.api.query('/api/2.0/segmentation/sum', _.extend(purchParams,dateObj), {dataType: 'json'})
          
          var previousAOV = MP.api.query('/api/2.0/segmentation/sum', _.extend(purchParams,previousRange), {dataType: 'json'})
          $.when(currentAOV, previousAOV).done(function(current, previous){
            var currentData =  MP.Data.inst(current.results).avg().values().toFixed(2);
            var pastData = MP.Data.inst(previous.results).avg().values().toFixed(2);
            dataAdd('Average Cart Size', currentData, pastData)
          })

          var currPurch = MP.api.events('Purchase',_.extend({unit:unit.val()}, dateObj))
          var previousPurch = MP.api.events('Purchase',_.extend({unit:unit.val()}, previousRange))
          
          $.when(currPurch, previousPurch).done(function(current, previous){
              var currentData =  MP.Data.inst(current.json["Purchase"]).avg().values();
              var pastData = MP.Data.inst(previous.json["Purchase"]).avg().values();
              dataAdd('Total Purchases', currentData, pastData)
            })
          
          var downloadsParams = {
            where:'properties["First App Open"] == true', 
            unit: 'month',type:'unique', 
          }
     
          
          var currDownloads = MP.api.segment('App Open',_.extend(downloadsParams,dateObj))
          var previousDownloads = MP.api.segment('App Open',_.extend(downloadsParams,previousRange))
          
          
          $.when(currDownloads, previousDownloads).done(function(current, previous) {
              var currentData =  MP.Data.inst(current.json["App Open"]).sum().values();
              var pastData = MP.Data.inst(previous.json["App Open"]).sum().values();
              dataAdd('Total Downloads', currentData, pastData)
            })
          
          
          var checkoutParams = {
            length: 7,
            length_unit: 'day',
          }
          
          var currCheckout = MP.api.funnel({"event":"Shopping Cart"},{"event":"Address Information"},{"event":"Shipping Method"},{"event":"Payment Method"},{"event":"Order Review"},{"event":"Purchase"}, _.extend(checkoutParams,dateObj))
          
          var previousCheckout = MP.api.funnel({"event":"Shopping Cart"},{"event":"Address Information"},{"event":"Shipping Method"},{"event":"Payment Method"},{"event":"Order Review"},{"event":"Purchase"}, _.extend(checkoutParams,previousRange))
          
          $.when(currCheckout, previousCheckout).done(function(current, previous){
            var currentUsers = 0
            var currentConv = 0
            var prevUsers = 0
            var prevConv = 0
            _.each(current[0], function(val, key){ currentUsers += val.count})
            _.each(current[current.length - 1], function(val, key){ currentConv += val.count})
            _.each(previous[0], function(val, key){ prevUsers += val.count})
            _.each(previous[previous.length - 1], function(val, key){ prevConv += val.count})
            if (currentUsers == 0) { currentUsers = 1}
            if (prevUsers == 0) { prevUsers = 1}
            var currentData = percent(currentConv, currentUsers);
            var pastData = percent(prevConv, prevUsers);
            percentAdd('Checkout', currentData, pastData)
          })
          
          var formulaParams = {
            formulas: [{"queries": [{"events": ["Purchase"], "count_type": "general"}, {"constant": 100}, {"events": ["App Open"], "count_type": "general"}], "formula": "(A*B)/(C)"}],
            unit: unit.val()
          }
          
          var segParams = {
              type: 'general',
              limit: 10000,
              unit: unit.val(),
            }
          var currentApp = MP.api.segment('App Open', _.extend(segParams, dateObj))
          var previousApp = MP.api.segment('App Open', _.extend(segParams, previousRange))
          var currentPurch = MP.api.segment('Purchase', _.extend(segParams, dateObj))
          var previousPurch = MP.api.segment('Purchase', _.extend(segParams, previousRange))
          $.when(currentApp, previousApp, currentPurch, previousPurch).done(function(currentApp, previousApp, currentPurch, previousPurch){
            debugger
            //redo this to truly account for % diff
            // total downloads over time frame / app opens.
            // Formulas cant work
            var currentData =  percent(MP.Data.inst(currentPurch.json["Purchase"]).sum().values(), MP.Data.inst(currentApp.json["App Open"]).sum().values());
            var pastData = percent(MP.Data.inst(previousPurch.json["Purchase"]).sum().values(), MP.Data.inst(previousApp.json["App Open"]).sum().values());
            percentAdd('Conversion', currentData, pastData)
          })
          
        }
        

        tableData()
        
        dateSelect.on('change', tableData)
        unit.on('change', tableData)
        
        function pad(d) {
            return (d < 10) ? '0' + d.toString() : d.toString();
        }
        
        function dataAdd(metric, current, previous){
          var difference = current - previous
          table.row.add({
            "Metric": metric,
            "Current": current,
            "Previous": previous,
            "Difference": difference.toFixed(2)
          }).draw();
        }
        
        function percentAdd(metric, current, previous){
          var difference = current - previous
          table.row.add({
            "Metric": metric,
            "Current": String(current) + "%",
            "Previous": String(previous) + "%",
            "Difference": String(difference) + "%"
          }).draw();
        }
    </script>
  </body>
</html>