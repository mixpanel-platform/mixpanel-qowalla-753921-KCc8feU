<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://d621cde4587c562960fbe230744f42dc2304ca4f.googledrive.com/host/0BxwayM8qQaCVX0w4RExCOVdhbzQ">
     <link rel="stylesheet" type="text/css" href="https://5a4961e5c9f1459a1c463234568af125d8e1b386.googledrive.com/host/0BxwayM8qQaCVRmRCSDlXUUtMMnc/">
  <link rel="stylesheet" type="text/css" href="https://201420392a7158f07d53a8f3e71606645ab03bd2.googledrive.com/host/0BxwayM8qQaCVQldvY2U5Um9FN3M">
    <script src="https://cdn.datatables.net/1.10.9/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.9/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"   integrity="sha256-xNjb53/rY+WmG+4L6tTl9m6PpqknWZvRt0rO1SRnJzw=" crossorigin="anonymous"></script>

  </head>
  <body class="mixpanel-platform-body">
<div class="content-wrapper">
    <div class="content-heading text-center">
      <!-- START Language list-->
      <div class="pull-right" style="bottom: 10px;">
        <img src="https://d018d7277c9a2a72c253b637c4abe4d24d29449c.googledrive.com/host/0BxwayM8qQaCVOGZvekkxYTNSZVU" height="40px" width="120px">
        
      </div>
      <div class="pull-left">
      </div>
      <!-- END Language list    -->
      Qowalla's Dashboard
      <small data-localize="dashboard.WELCOME"></small>
    </div>
    <!-- START widgets box-->
    <div class="row">
      <div class="col-lg-3 col-sm-3">
        <!-- START widget-->
        <div class="panel widget bg-primary">
          <div class="row row-table">
            <div class="col-xs-4 text-center bg-primary-dark pv-lg">
              <i class="fa fa-cloud-download fa-3x"></i>
            </div>
            <div class="col-xs-8 pv-lg">
              <div class="h2 mt0 total-downloads text-center">0</div>
              <div class="text-uppercase text-center">Total Downloads</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-sm-3">
        <!-- START widget-->
        <div class="panel widget bg-purple">
          <div class="row row-table">
            <div class="col-xs-4 text-center bg-purple-dark pv-lg">
              <i class="fa fa-shopping-cart fa-3x"></i>
            </div>
            <div class="col-xs-8 pv-lg">
              <div class="h2 mt0 average-cart text-center">0
                <!--<small>GB</small>-->
              </div>
              <div class="text-uppercase text-center">Average Order Value</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6 col-sm-3">
        <!-- START widget-->
        <div class="panel widget bg-green">
          <div class="row row-table">
            <div class="col-xs-4 text-center bg-green-dark pv-lg">
              <i class="fa fa-money fa-3x"></i>
            </div>
            <div class="col-xs-8 pv-lg">
              <div class="h2 mt0 daily-actives text-center">0</div>
              <div class="text-uppercase text-center">Total Purchases</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6 col-sm-3">
        <!-- START date widget-->
        <div class="panel widget">
          <div class="row row-table">
            <div class="col-xs-4 text-center bg-green pv-lg">
              <!-- See formats: https://docs.angularjs.org/api/ng/filter/date-->
              <div data-now="" data-format="MMMM" class="text-sm date-month text-center"></div>
              <br>
              <div data-now="" data-format="D" class="h2 mt0 date-day text-center"></div>
            </div>
            <div class="col-xs-8 pv-lg">
              <div data-now="" data-format="dddd" class="text-uppercase date-actual-day text-center"></div>
              <br>
              <div data-now="" data-format="h:mm" class="h2 mt0 date-time"></div>
              <div data-now="" data-format="a" class="text-muted text-sm date-pm"></div>
            </div>
          </div>
        </div>
        <!-- END date widget    -->
      </div>
    </div>
    <div class="row">
      <div class="col-lg-12">
        <div class="panel panel-default">
          <div class="panel-heading text-center">
            Metrics
          </div>
          <input type="text" id="dateSelect"><br/><br/>
          <div style="clear: both;"></div>
          <div id="dateRange"></div>
          <div class="panel-body">
            <div id="datatable1_wrapper" class="dataTables_wrapper form-inline no-footer">
              <div class="row">
                <div class="col-xs-6">
                  <table id="table" class="display" width="100%"></table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
</div>


    <script>
        /* Get top events */
        var dateSelect  = $('#dateSelect').datepicker({
          maxDate: new Date(),
        });
        
        $( "#dateSelect" ).datepicker( "setDate", new Date() )
        var options = {
            items: [
              {label: 'Day', value: 'day'},
              {label: 'Week', value: 'week'},
              {label: 'Month', value: 'month'},
            ]
        };
        
        var unit = $('#dateRange').MPSelect(options);

       
        events = [];
        MP.api.topEvents().done(function(results) {
          _.each(_.values(results.values()), function(value){
              events.push(value);
          })
          query()
        });

        function toTitleCase(str)
        {
          return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
        }

        function addCommas(intNum) {
          return (intNum + '').replace(/(\d)(?=(\d{3})+$)/g, '$1,');
        }

        function query() {
          /* 
              Get total event counts 
              event:App Open
              type:general
              limit:255
              on:properties["First App Open"]
              to_date:2015-11-11
              from_date:2015-10-13
              unit:day
          */
          var params = {}
          var paramsLastPeriod = {}
          var period = null
          
          /* Query for total Downloads */
          var downloadsQuery = MP.api.segment('App Open', {where:'properties["First App Open"] == true', unit: 'month',type:'unique', from: moment().subtract(12, 'months')})
          
          downloadsQuery.done(function(json) {
              /* Show this now */
              console.log(json);
              var total = _.sum(_.values(json.values()['App Open']));
              $('.total-downloads').text(addCommas(total));
            })
            
            /* Query for Average Cart Value */
            var purchParams = {
              event: 'Purchase',
              type: 'general',
              limit: 10000,
              on: 'number(properties["Purchase Dollar Amount"])',
              unit: 'day',
              to: moment(),
              from: moment().subtract(12, 'months'),
            }
            
            var averageCart = MP.api.query('/api/2.0/segmentation/average', purchParams, {dataType: 'json'}) 
            averageCart.done(function(json){
                console.log(json)
                var data = _.values(json.results)
                var averageCartVals = (data.reduce(function(sum, a) { return sum + Number(a) }, 0) / data.length).toFixed(2)
                $('.average-cart').text(addCommas('$' + averageCartVals));
            });
            
            /* Year to Date Purchases */
            var purchaseQuery = MP.api.events('Purchase', {from: moment().subtract(12, 'months'), unit: 'month'})
            purchaseQuery.done(function(json){
                var total = _.sum(_.values(json.values()['Purchase']));
                $('.daily-actives').text(addCommas(total));
                
            })
            /* update datatable to meet the email from jennifer */
            var table = $('#datatable1').DataTable();
            table.clear();
            
            
            /* iOS and Android Downloads */
            var platformDownloads = MP.api.segment('App Open', '$os', {where: 'properties["First App Open"] == true', from: moment().subtract(14, 'days'), unit:'week', type:'unique'});
            platformDownloads.done(function(results){

                var values = _.keys(results.values());
                _.each(values, function(value){
                    dates = results.values()[value];
                    /* sum over data in value of results.values()[key] */
                    var total = 0;
                    var sortedDates = _.keys(dates)
                    var difference = 0;
                    /* sort and reverse */
                    sortedDates.sort();
                    sortedDates.reverse();
                    console.log(sortedDates)
                    var currentWeek = dates[sortedDates[0]];
                    var previousWeek = dates[sortedDates[1]];
                    if (currentWeek != 0 && previousWeek != 0){
                        var difference = (currentWeek/previousWeek);
                    }
                })
            });   
            
            var totalPurchases = MP.api.segment('Purchase', '$os', {from: moment().subtract(14, 'days'), unit:'week'});
            totalPurchases.done(function(results){
              
                console.log(results.values());
                var values = _.keys(results.values());
                _.each(values, function(value){
                    dates = results.values()[value];
                    /* sum over data in value of results.values()[key] */
                    
                    var sortedDates = _.keys(dates)
                    var difference = 0;
                    /* sort and reverse */
                    sortedDates.sort();
                    sortedDates.reverse();
                    console.log(sortedDates)
                    var currentWeek = dates[sortedDates[0]];
                    var previousWeek = dates[sortedDates[1]];
                    if (currentWeek != 0 && previousWeek != 0){
                        var difference = (currentWeek/previousWeek)*100;
                    }
                })
            });   
            
            /* Total + Licensed Content Purchases */
            
            
            var purchases = MP.api.events('Licensed Content Purchases', 'Total Content Purchases', {from: moment().subtract(14, 'days'), unit: 'week'})
            purchases.done(function(results) {
                var values = _.keys(results.values())
                _.each(values, function(value){
                    dates = results.values()[value];
                    /* sum over data in value of results.values()[key] */
                    
                    var sortedDates = _.keys(dates)
                    var difference = 0;
                    /* sort and reverse */
                    sortedDates.sort();
                    sortedDates.reverse();
                    console.log(sortedDates)
                    var currentWeek = dates[sortedDates[0]];
                    var previousWeek = dates[sortedDates[1]];
                    if (currentWeek != 0 && previousWeek != 0){
                        var difference = (currentWeek/previousWeek)*100;
                    }
                })
            });
        }
        

        function tableData(){
           var table = $('.table').DataTable( {
                  columns: [
                      { title: "Metric" , data: 'Metric' },
                      { title: "Current", data: 'Current' },
                      { title: "Previous", data: 'Previous' },
                      { title: "Difference", data: 'Difference' },
                    ]
              });
          table.clear()
          debugger
          var date = moment(dateSelect.val())
          
          var dateObj = {
            to: date.utc().format('YYYY-MM-DD'),
            from: date.subtract(1, unit.val()).utc().format('YYYY-MM-DD')
          }
          
          var previousRange = {
            to: moment(dateObj.from).subtract(1, unit.val()).utc().format('YYYY-MM-DD'),
            from: moment(dateObj.from).subtract(2, unit.val()).utc().format('YYYY-MM-DD')
          }
          
          var purchParams = {
              event: 'Purchase',
              type: 'general',
              limit: 10000,
              on: 'number(properties["Purchase Dollar Amount"])',
              unit: unit.val(),
            }
            
          var currentPurch = MP.api.query('/api/2.0/segmentation/sum', _.extend(purchParams,dateObj), {dataType: 'json'})
          
          var previousPurch = MP.api.query('/api/2.0/segmentation/sum', _.extend(purchParams,previousRange), {dataType: 'json'})
          $.when(currentPurch, previousPurch).done(function(current, previous){
            var currentData =  MP.Data.inst(current.results).sum().values();
            var pastData = MP.Data.inst(previous.results).sum().values();
            dataAdd('Purchases', currentData, pastData)
          })
          
          var checkoutParams = {
            length: 7,
            length_unit: unit.val()
          }
          
          // double check that > 90 day windows don't break funnels
          // set window to be D/W/M pick start date and we will subtract D/W/M
          // total downloads
          // total purchases
          // average order value
          // conversion rate == total purchases / total app opens formula
          
          var currCheckout = MP.api.funnel({"event":"Shopping Cart"},{"event":"Address Information"},{"event":"Shipping Method"},{"event":"Payment Method"},{"event":"Order Review"},{"event":"Purchase"}, _.extend(checkoutParams,dateObj))
          
          var previousCheckout = MP.api.funnel({"event":"Shopping Cart"},{"event":"Address Information"},{"event":"Shipping Method"},{"event":"Payment Method"},{"event":"Order Review"},{"event":"Purchase"}, _.extend(checkoutParams,previousRange))
          
          $.when(currCheckout, previousCheckout).done(function(current, previous){
             var currentData =  MP.Data.inst(current.results).sum().values();
            var pastData = MP.Data.inst(previous.results).sum().values();
            dataAdd('Checkout', currentData, pastData)
          })
          
          var formulaParams = {
            formulas: [{"queries": [{"events": ["Purchase"], "count_type": "general"}, {"constant": 100}, {"events": ["App Open"], "count_type": "general"}], "formula": "(A*B)/(C)"}],
            unit: unit.val()
          }
          
          var currentConv = MP.api.query('/api/2.0/formulas', _.extend(formulaParams, dateObj))
          var previousConv = MP.api.query('/api/2.0/formulas', _.extend(formulaParams, previousRange))
          
          $.when(currentConv, previousConv).done(function(current, previous){
             var currentData =  MP.Data.inst(current.results).sum().values();
            var pastData = MP.Data.inst(previous.results).sum().values();
            dataAdd('Conversion', currentData, pastData)
          })
          
        }
        

        tableData()
        
        dateSelect.on('change', tableData)
        unit.on('change', tableData)
        
        function pad(d) {
            return (d < 10) ? '0' + d.toString() : d.toString();
        }
        
        function dataAdd(metric, current, previous){
          var difference = current - previous
          table.row.add({
            "Metric": metric,
            "Current": current,
            "Previous": previous,
            "Difference": difference
          }).draw();
        }
        
        function getCurrentMonth(){

            var d = new Date();

            var month = new Array();
            month[0] = "JAN"; 
            month[1] = "FEB";
            month[2] = "MAR";
            month[3] = "APR";
            month[4] = "MAY";
            month[5] = "JUNE";
            month[6] = "JULY";
            month[7] = "AUG";
            month[8] = "SEPT";
            month[9] = "OCT";
            month[10] = "NOV";
            month[11] = "DEC";
            var n = month[d.getMonth()];

            return n;
        }

        function getCurrentDay(){
            var d = new Date();
            var weekday = new Array(7);
            weekday[0]=  "Sunday";
            weekday[1] = "Monday";
            weekday[2] = "Tuesday";
            weekday[3] = "Wednesday";
            weekday[4] = "Thursday";
            weekday[5] = "Friday";
            weekday[6] = "Saturday";

            var n = weekday[d.getDay()];
            return n;
        }
    </script>
  </body>
</html>